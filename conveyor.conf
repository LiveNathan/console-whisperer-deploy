include required("https://raw.githubusercontent.com/hydraulic-software/conveyor/master/configs/jvm/extract-native-libraries.conf")
include required("/stdlib/jdk/25/openjdk.conf")

app {
  fsname = console-whisperer-desktop
  display-name = "Console Whisperer"
  rdns-name = "dev.nathanlively"
  version = ${env.APP_VERSION}
  icons = "app-icon.svg"
  vcs-url = "https://github.com/LiveNathan/console-whisperer-deploy"
  compression-level = high
  inputs += "target/*.jar"

  site {
    github {
      oauth-token = ${env.GITHUB_TOKEN}
      pages-branch = "gh-pages"
    }
  }

  jvm {
    # Java 25 is now supported natively in Conveyor 21+
    feature-version = 25
    version = "25.0"

    gui {
      main-class = "org.springframework.boot.loader.launch.JarLauncher"
      console = false
    }

    # Memory settings
    options += "-Xms256m"
    options += "-Xmx1g"
    options += "-XX:+UseG1GC"

    system-properties {
      "server.port" = 22019
      "spring.application.name" = "console-whisperer-desktop"
      "logging.level.org.atmosphere" = "warn"
      "spring.mustache.check-template-location" = false
      "vaadin.launch-browser" = false
      "spring.threads.virtual.enabled" = true
      "logging.level.org.springframework.ai.chat.client.advisor" = "DEBUG"
      "logging.level.dev.nathanlively" = "debug"
      "embabel.models.default-llm" = "gemini-2.5-flash"
      "spring.servlet.multipart.max-file-size" = "25MB"
    }

    # Required --add-opens for Spring Boot 3.x with Java 25
    options += "--add-opens=java.base/java.lang=ALL-UNNAMED"
    options += "--add-opens=java.base/java.util=ALL-UNNAMED"
    options += "--add-opens=java.base/java.text=ALL-UNNAMED"
    options += "--add-opens=java.base/java.net=ALL-UNNAMED"
    options += "--add-opens=java.base/java.nio=ALL-UNNAMED"
    options += "--add-opens=java.base/java.lang.reflect=ALL-UNNAMED"
    options += "--add-opens=java.base/java.time=ALL-UNNAMED"
    options += "--add-opens=java.base/java.util.concurrent=ALL-UNNAMED"
    options += "--add-opens=java.management/sun.management=ALL-UNNAMED"
    options += "--enable-native-access=ALL-UNNAMED"
    mac.options += "-XstartOnFirstThread"

    modules = [
      jdk.zipfs
      java.management
      java.management.rmi
      java.naming
      java.sql
      java.security.jgss
      java.desktop
      java.instrument
      java.compiler
      jdk.unsupported
      java.logging
      java.prefs
      java.xml
      java.datatransfer
      java.security.sasl
      java.net.http
      java.scripting
      jdk.attach
      jdk.management
      jdk.crypto.ec
    ]
  }

  machines = [ "mac", "windows.amd64" ]
  updates = aggressive
}

conveyor.compatibility-level = 21
