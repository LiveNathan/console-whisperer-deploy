name: Package with Conveyor

on:
  repository_dispatch:
    types: [release-agent]
  workflow_dispatch:
    inputs:
      version:
        description: 'App version'
        required: true
        type: string
      run_id:
        description: 'Run ID from private repo'
        required: true
        type: string

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Disk and inode usage (debug)
        run: |
          echo "=== df -h ==="
          df -h || true
          echo "=== df -i (inodes) ==="
          df -i / || df -i || true
          echo "=== mount info ==="
          mount | grep ' /home' || mount || true
          echo "=== top-level du -sh ==="
          du -sh . || true
          echo "=== home du -sh ==="
          du -sh /home/runner || true

      - name: Verbose runner diag inspect and cleanup (targeted)
        run: |
          set -o pipefail
          DIAG_DIR="/home/runner/actions-runner/cached/_diag"
          CACHED_DIR="/home/runner/actions-runner/cached"

          echo "=== pre-cleanup: df -h ==="
          df -h || true
          echo "=== pre-cleanup: df -i ==="
          df -i / || df -i || true

          echo "=== cached path sizes ==="
          sudo du -sh "${CACHED_DIR}" 2>/dev/null || echo "no cached dir"
          sudo du -sh "${DIAG_DIR}" 2>/dev/null || echo "no diag dir"

          echo "=== file counts ==="
          sudo find "${CACHED_DIR}" -xdev -type f 2>/dev/null | wc -l || true
          echo "files in _diag (maxdepth 1):"
          sudo find "${DIAG_DIR}" -maxdepth 1 -type f 2>/dev/null | wc -l || true

          echo "=== largest files in _diag (pre) ==="
          sudo find "${DIAG_DIR}" -maxdepth 1 -type f -printf '%s %p\n' 2>/dev/null | sort -nr | head -n 50 || true

          echo "=== recent entries in _diag (pre) ==="
          sudo ls -la --time-style=full-iso "${DIAG_DIR}" 2>/dev/null | tail -n 80 || true

          echo "=== attempting verbose removal of files in _diag ==="
          if [ -d "${DIAG_DIR}" ]; then
            # show and attempt deletion of files individually so we capture errors
            sudo find "${DIAG_DIR}" -maxdepth 1 -type f -print0 2>/dev/null | xargs -0 -r -n1 -P1 sh -c 'f="$0"; echo "REMOVING: $f"; rm -vf "$f" || echo "FAILED REMOVE: $f (exit:$?)"' 
            # remove empty dirs if any
            sudo find "${DIAG_DIR}" -mindepth 1 -type d -print0 2>/dev/null | xargs -0 -r -n1 -P1 sh -c 'd="$0"; echo "RMDIR: $d"; rmdir -v "$d" || echo "FAILED RMDIR: $d (exit:$?)"'
          else
            echo "${DIAG_DIR} does not exist"
          fi

          # Also attempt to aggressively remove cached temp files (best-effort)
          echo "=== attempting removal of cached tmp/tool/temp files (best-effort) ==="
          sudo rm -rfv /home/runner/actions-runner/_work/_temp/* 2>/dev/null || true
          sudo rm -rfv /home/runner/actions-runner/_work/_tool/* 2>/dev/null || true
          sudo rm -rfv /home/runner/.cache/* 2>/dev/null || true
          sudo rm -rfv /tmp/* 2>/dev/null || true

          echo "=== post-cleanup: df -h ==="
          df -h || true
          echo "=== post-cleanup: df -i ==="
          df -i / || df -i || true

          echo "=== post-cleanup cached path sizes ==="
          sudo du -sh "${CACHED_DIR}" 2>/dev/null || true
          sudo du -sh "${DIAG_DIR}" 2>/dev/null || true

      - name: Download JAR from private repo
        env:
          GH_TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
        run: |
          # Use workflow_dispatch inputs if available, otherwise use repository_dispatch payload
          RUN_ID="${{ github.event.inputs.run_id || github.event.client_payload.run_id }}"
          SOURCE_REPO="${{ github.event.inputs.source_repo || github.event.client_payload.source_repo || 'LiveNathan/console-whisperer-desktop' }}"
          echo "Downloading artifact from $SOURCE_REPO run $RUN_ID to target/"
          gh run download "$RUN_ID" \
            --repo "$SOURCE_REPO" \
            --name jar-artifact \
            --dir target/

      - name: Verify JAR was downloaded
        run: |
          if ! ls target/*.jar >/dev/null 2>&1; then
            echo "ERROR: No JAR file found in target/ directory"
            ls -la target/ || echo "target/ directory doesn't exist"
            exit 1
          fi
          echo "Found JAR file(s):"
          ls -la target/*.jar
          size=$(stat -c%s target/*.jar || true)
          if [ -n "$size" ] && [ "$size" -gt $((500*1024*1024)) ]; then
            echo "ERROR: Downloaded JAR is larger than 500MB (${size} bytes). Aborting to avoid exhausting runner disk."
            exit 1
          fi

      - name: Run Conveyor
        uses: hydraulic-software/conveyor/actions/build@v20.0
        env:
          APP_VERSION: ${{ github.event.inputs.version || github.event.client_payload.version }}
          GITHUB_TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
          OAK: ${{ secrets.OAK }}
        with:
          command: make copied-site
          signing_key: ${{ secrets.SIGNING_KEY }}
          agree_to_license: 1

      - name: Post-build cleanup
        if: always()
        run: |
          echo "Removing target/ to free disk"
          rm -rf target/ || true
          echo "Post-cleanup disk usage:"
          df -h || true
          df -i / || df -i || true
