name: Package with Conveyor

on:
  repository_dispatch:
    types: [release-agent]
  workflow_dispatch:
    inputs:
      version:
        description: 'App version'
        required: true
        type: string
      run_id:
        description: 'Run ID from private repo'
        required: true
        type: string

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Disk and inode usage (debug)
        run: |
          echo "=== df -h ==="
          df -h || true
          echo "=== df -i (inodes) ==="
          df -i / || df -i || true
          echo "=== top-level du -sh ==="
          du -sh . || true
          echo "=== home du -sh ==="
          du -sh /home/runner || true

      - name: Detect and free deleted-but-open files (diagnose + optional kill)
        run: |
          set -euo pipefail
          CACHED_PREFIX="/home/runner/actions-runner/cached"
          TMP="/tmp/lsof_deleted_cached.txt"

          echo "Listing deleted-but-open files (lsof +L1). This shows files that are deleted from the directory tree but still held open by processes."
          sudo lsof +L1 2>/dev/null | sed -n '1,200p' || true

          echo
          echo "Filtering for files under ${CACHED_PREFIX}:"
          sudo lsof +L1 2>/dev/null | grep "${CACHED_PREFIX}" || echo "No lsof entries matching ${CACHED_PREFIX}"

          echo
          echo "Collecting PIDs holding files under ${CACHED_PREFIX}..."
          sudo lsof +L1 2>/dev/null | awk -v prefix="${CACHED_PREFIX}" '
            $0 ~ prefix { print $2 " " $1 " " $9 }
          ' | sort -u > "${TMP}" || true

          if [ ! -s "${TMP}" ]; then
            echo "No processes found holding deleted files under ${CACHED_PREFIX}."
          else
            echo "Processes holding files (PID PROCESS FILE):"
            cat "${TMP}"
            echo

            echo "Unique PIDs:"
            awk '{print $1}' "${TMP}" | sort -u | while read -r pid; do
              echo "---- PID ${pid} ----"
              ps -p "${pid}" -o pid,uid,user,cmd --no-headers || echo "ps failed for ${pid}"
            done

            echo
            echo "KILL PLAN: Will forcibly kill runner-owned processes that hold deleted files under ${CACHED_PREFIX}."
            echo "This will likely cause this job to fail (intended), but will free kernel-held disk blocks so subsequent runs can write logs."

            # Only kill processes owned by 'runner' (safer); adjust if your runner user differs.
            awk '{print $1}' "${TMP}" | sort -u | while read -r pid; do
              owner=$(ps -p "${pid}" -o user= 2>/dev/null || true)
              cmd=$(ps -p "${pid}" -o cmd= 2>/dev/null || true)
              echo "PID=${pid} OWNER=${owner} CMD=${cmd}"
              if [ "${owner}" = "runner" ] || [ "${owner}" = "root" ]; then
                echo "KILLING PID ${pid} (owner=${owner})"
                sudo kill -9 "${pid}" || echo "Failed to kill ${pid} (it may have exited already)"
              else
                echo "Skipping PID ${pid} (owner=${owner}) â€” not 'runner' or 'root'"
              fi
            done
          fi

          echo
          echo "After killing, show df -h and df -i:"
          df -h || true
          df -i / || df -i || true

      - name: Download JAR from private repo
        env:
          GH_TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
        run: |
          # Use workflow_dispatch inputs if available, otherwise use repository_dispatch payload
          RUN_ID="${{ github.event.inputs.run_id || github.event.client_payload.run_id }}"
          SOURCE_REPO="${{ github.event.inputs.source_repo || github.event.client_payload.source_repo || 'LiveNathan/console-whisperer-desktop' }}"
          echo "Downloading artifact from $SOURCE_REPO run $RUN_ID to target/"
          gh run download "$RUN_ID" \
            --repo "$SOURCE_REPO" \
            --name jar-artifact \
            --dir target/

      - name: Verify JAR was downloaded
        run: |
          if ! ls target/*.jar >/dev/null 2>&1; then
            echo "ERROR: No JAR file found in target/ directory"
            ls -la target/ || echo "target/ directory doesn't exist"
            exit 1
          fi
          echo "Found JAR file(s):"
          ls -la target/*.jar
          size=$(stat -c%s target/*.jar || true)
          if [ -n "$size" ] && [ "$size" -gt $((500*1024*1024)) ]; then
            echo "ERROR: Downloaded JAR is larger than 500MB (${size} bytes). Aborting to avoid exhausting runner disk."
            exit 1
          fi

      - name: Run Conveyor
        uses: hydraulic-software/conveyor/actions/build@v20.0
        env:
          APP_VERSION: ${{ github.event.inputs.version || github.event.client_payload.version }}
          GITHUB_TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
          OAK: ${{ secrets.OAK }}
        with:
          command: make copied-site
          signing_key: ${{ secrets.SIGNING_KEY }}
          agree_to_license: 1

      - name: Post-build cleanup
        if: always()
        run: |
          echo "Removing target/ to free disk"
          rm -rf target/ || true
          echo "Post-cleanup disk usage:"
          df -h || true
          df -i / || df -i || true
